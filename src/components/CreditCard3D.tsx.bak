import { useState, useEffect, useRef, useMemo } from 'react';

interface CreditCard3DProps {
  cardNumber: string;
  cardName: string;
  cardMonth: string;
  cardYear: string;
  cardCvv: string;
  focusedField: string | null; // Novo: saber qual campo está focado
}

export function CreditCard3D({
  cardNumber,
  cardName,
  cardMonth,
  cardYear,
  cardCvv,
  focusedField,
}: CreditCard3DProps) {
  const [focusStyle, setFocusStyle] = useState<React.CSSProperties | null>(null);
  
  // Imagem de fundo aleatória (similar ao script.js original)
  const [bgImage] = useState(() => {
    const random = Math.floor(Math.random() * 25 + 1);
    return `https://raw.githubusercontent.com/muhammederdem/credit-card-form/master/src/assets/images/${random}.jpeg`;
  });

  // Refs para os elementos no cartão
  const cardNumberRef = useRef<HTMLDivElement>(null);
  const cardNameRef = useRef<HTMLLabelElement>(null);
  const cardDateRef = useRef<HTMLDivElement>(null);

  // Calcula a posição do "Focus Box" quando o campo focado muda
  useEffect(() => {
    if (!focusedField) {
      setFocusStyle(null);
      return;
    }

    let targetRef: HTMLElement | null = null;

    if (focusedField === 'cardNumber') targetRef = cardNumberRef.current;
    if (focusedField === 'cardName') targetRef = cardNameRef.current;
    if (focusedField === 'cardDate') targetRef = cardDateRef.current;

    if (targetRef) {
      setFocusStyle({
        width: `${targetRef.offsetWidth}px`,
        height: `${targetRef.offsetHeight}px`,
        transform: `translateX(${targetRef.offsetLeft}px) translateY(${targetRef.offsetTop}px)`,
        opacity: 1
      });
    } else {
      setFocusStyle(null);
    }
  }, [focusedField]);

  const getCardType = useMemo(() => {
    const number = cardNumber.replace(/\s/g, '');
    if (/^4/.test(number)) return 'visa';
    if (/^(34|37)/.test(number)) return 'amex';
    if (/^5[1-5]/.test(number)) return 'mastercard';
    if (/^6011/.test(number)) return 'discover';
    if (/^9792/.test(number)) return 'troy';
    return 'visa';
  }, [cardNumber]);

  const isFlipped = focusedField === 'cardCvv';

  // Formatação com animação (simplificada para React)
  const renderCardNumber = () => {
    const mask = getCardType === 'amex' ? '#### ###### #####' : '#### #### #### ####';
    const text = cardNumber.padEnd(mask.length, '#');
    
    return text.split('').map((char, index) => {
      // Lógica visual do Vue portada:
      if (index > 4 && index < 15 && cardNumber.length > index && char.trim() !== '' && getCardType !== 'amex') {
        return <span key={index} className="card-item__numberItem">*</span>;
      }
      return (
        <span key={index} className={`card-item__numberItem ${char === '#' ? '' : '-active'}`}>
          {char === '#' ? '' : char}
        </span>
      );
    });
  };

  return (
    <div className={`card-item ${isFlipped ? '-active' : ''}`}>
      {/* Lado da Frente */}
      <div className="card-item__side -front">
        <div 
            className={`card-item__focus ${focusStyle ? '-active' : ''}`} 
            style={focusStyle || {}} 
        />
        <div className="card-item__cover">
          <img src={bgImage} className="card-item__bg" alt="Background" />
        </div>
        
        <div className="card-item__wrapper">
          <div className="card-item__top">
            <img 
              src="https://raw.githubusercontent.com/muhammederdem/credit-card-form/master/src/assets/images/chip.png" 
              className="card-item__chip" 
              alt="Chip"
            />
            <div className="card-item__type">
              <img
                src={`https://raw.githubusercontent.com/muhammederdem/credit-card-form/master/src/assets/images/${getCardType}.png`}
                alt={getCardType}
                className="card-item__typeImg"
              />
            </div>
          </div>

          <div 
            className="card-item__number" 
            ref={cardNumberRef}
          >
            {renderCardNumber()}
          </div>

          <div className="card-item__content">
            <label 
                className="card-item__info" 
                ref={cardNameRef}
            >
              <div className="card-item__holder">Card Holder</div>
              <div className="card-item__name">
                {cardName.length ? cardName : 'FULL NAME'}
              </div>
            </label>

            <div 
                className="card-item__date" 
                ref={cardDateRef}
            >
              <label className="card-item__dateTitle">Expires</label>
              <label className="card-item__dateItem">
                <span>{cardMonth || 'MM'}</span>
              </label>
              /
              <label className="card-item__dateItem">
                <span>{cardYear ? cardYear.slice(2, 4) : 'YY'}</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      {/* Verso */}
      <div className="card-item__side -back">
        <div className="card-item__cover">
          <img src={bgImage} className="card-item__bg" alt="Background" />
        </div>
        <div className="card-item__band" />
        <div className="card-item__cvv">
          <div className="card-item__cvvTitle">CVV</div>
          <div className="card-item__cvvBand">
            {cardCvv.split('').map((_, i) => <span key={i}>*</span>)}
          </div>
          <div className="card-item__type">
             <img
                src={`https://raw.githubusercontent.com/muhammederdem/credit-card-form/master/src/assets/images/${getCardType}.png`}
                className="card-item__typeImg"
                alt="Type"
             />
          </div>
        </div>
      </div>
    </div>
  );
}
